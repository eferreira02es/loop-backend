<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LooP - Gerenciador de Playlist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #1DB954, #1ed760);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-card h3 {
            color: #1DB954;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #aaa;
            font-size: 0.9rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            flex: 1;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #1DB954;
            color: #000;
            font-weight: bold;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            color: #1DB954;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.85rem;
        }

        input,
        select {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            width: 100%;
        }

        input:focus {
            outline: 2px solid #1DB954;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(90deg, #1DB954, #1ed760);
            color: #000;
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: #1DB954;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pendente {
            background: #f39c12;
            color: #000;
        }

        .status-execucao {
            background: #1DB954;
            color: #000;
        }

        .status-concluido {
            background: #3498db;
            color: #fff;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1DB954;
            transition: width 0.3s ease;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: #1DB954;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #16213e;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>üéµ LooP</h1>
            <p>Gerenciador Inteligente de Playlist</p>
        </header>

        <div class="stats">
            <div class="stat-card">
                <h3><span class="online-dot"></span><span id="devices-count">0</span></h3>
                <p>Dispositivos Online</p>
            </div>
            <div class="stat-card">
                <h3 id="tempo-restante">--:--:--</h3>
                <p>Tempo Restante (Hoje)</p>
            </div>
            <div class="stat-card">
                <h3 id="tempo-planejado">--:--:--</h3>
                <p>Tempo Planejado</p>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('adicionar')">‚ûï Adicionar M√∫sica</button>
            <button class="tab-btn" onclick="openTab('playlists')">üìã Gerenciar Playlists</button>
            <button class="tab-btn" onclick="openTab('controle')">üìä Controle & Metas</button>
            <button class="tab-btn" onclick="openTab('todas')">üéµ Todas as M√∫sicas</button>
        </div>

        <!-- Tab: Adicionar M√∫sica (Smart) -->
        <div id="adicionar" class="tab-content active">
            <div class="card">
                <h2>Adicionar M√∫sica (Valida√ß√£o Autom√°tica)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Link do Spotify</label>
                        <input type="url" id="smart-link" placeholder="https://open.spotify.com/track/..." required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Plays Di√°rios Desejados</label>
                        <input type="number" id="smart-plays" value="100" min="1">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Meta Mensal</label>
                            <input type="number" id="smart-meta" value="3000" min="1">
                        </div>
                        <div class="form-group">
                            <label>Ciclo (Minutos) - Opcional</label>
                            <input type="number" id="smart-duracao" placeholder="Auto (Spotify)" step="0.1" min="0.1">
                            <small style="color: #666">Deixe vazio para usar dura√ß√£o do Spotify</small>
                        </div>
                    </div>
                    <button onclick="adicionarMusicaSmart()" class="btn btn-primary" style="width: 100%">Validar e
                        Adicionar</button>
                </div>

                <div class="card">
                    <h2>Fila de Execu√ß√£o (Hoje)</h2>
                    <div class="actions" style="margin-bottom: 15px;">
                        <a href="/reset_all_plays" class="btn btn-danger"
                            onclick="return confirm('Resetar fila?')">Resetar
                            Fila</a>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>M√∫sica</th>
                                <th>Progresso</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="playlist-body">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Gerenciar Playlists -->
        <div id="playlists" class="tab-content">
            <div class="card">
                <h2>Adicionar Nova Playlist</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Link da Playlist</label>
                        <input type="url" id="playlist-url" placeholder="https://open.spotify.com/playlist/...">
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <button onclick="adicionarPlaylist()" class="btn btn-primary">Adicionar</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Playlists Cadastradas</h2>
                <table id="playlists-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Link</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Controle & Config -->
        <div id="controle" class="tab-content">
            <div class="card"
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h2>Configura√ß√µes</h2>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label for="status-filter">Filtrar:</label>
                        <select id="status-filter" onchange="loadStats()" style="padding: 8px; border-radius: 5px;">
                            <option value="todos">Todos</option>
                            <option value="progresso">Em Progresso</option>
                            <option value="atingida">Meta Atingida</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label for="reset-auto-toggle">Reset Autom√°tico (21h)</label>
                        <input type="checkbox" id="reset-auto-toggle" onchange="toggleResetAuto(this)"
                            style="width: auto;">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Painel de Controle Mensal</h2>
                <table id="stats-table">
                    <thead>
                        <tr>
                            <th>M√∫sica</th>
                            <th>Plays Hoje</th>
                            <th>Plays M√™s</th>
                            <th>Meta Mensal</th>
                            <th>Status</th>
                            <th>Gr√°fico</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS -->
                    </tbody>
                </table>
            </div>

            <!-- Gr√°fico de Linha do Tempo -->
            <div class="card" id="chart-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 id="chart-title">Hist√≥rico de Plays</h2>
                    <button onclick="hideChart()" class="btn btn-secondary" style="padding: 5px 15px;">‚úï Fechar</button>
                </div>
                <canvas id="playsChart" height="100"></canvas>
            </div>
        </div>

        <!-- Tab: Todas as M√∫sicas -->
        <div id="todas" class="tab-content">
            <div class="card">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <h2>üéµ Todas as M√∫sicas no Banco</h2>
                    <button onclick="deleteAllSongs()" class="btn btn-danger">üóëÔ∏è Deletar Tudo</button>
                </div>
                <p style="color: #888; margin: 10px 0;">M√∫sicas rastreadas na tabela de controle (meta mensal)</p>
                <table id="all-songs-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Track ID</th>
                            <th>Plays M√™s</th>
                            <th>Meta</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal Loading -->
        <div id="loading" class="modal">
            <div class="modal-content">
                <h3 style="color: #1DB954; margin-bottom: 15px;">Processando...</h3>
                <p id="loading-text">Validando m√∫sica nas playlists...</p>
            </div>
        </div>
    </div>

    <script>
        // Tabs Logic
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'playlists') loadPlaylists();
            if (tabName === 'controle') {
                loadStats();
                loadConfig();
            }
            if (tabName === 'todas') loadAllSongs();
        }

        function loadAllSongs() {
            fetch('/api/all_songs')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector('#all-songs-table tbody');
                    tbody.innerHTML = '';
                    if (!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6">Nenhuma m√∫sica no banco.</td></tr>';
                        return;
                    }
                    data.forEach(song => {
                        const row = `<tr>
                            <td>${song.id}</td>
                            <td>${song.nome || 'Sem nome'}</td>
                            <td style="font-size: 0.8rem; color: #888;">${song.track_id?.substring(0, 15) || '-'}...</td>
                            <td>${song.plays_mes_atual || 0}</td>
                            <td>${song.meta_mensal || 0}</td>
                            <td><button onclick="deleteSong(${song.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">üóëÔ∏è</button></td>
                        </tr>`;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                })
                .catch(err => alert('Erro ao carregar m√∫sicas: ' + err.message));
        }

        function deleteSong(id) {
            if (confirm('Deletar esta m√∫sica do banco?')) {
                fetch(`/api/songs/${id}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) throw new Error(data.error);
                        loadAllSongs();
                    })
                    .catch(err => alert('Erro: ' + err.message));
            }
        }

        function deleteAllSongs() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso vai DELETAR TODAS as m√∫sicas do banco!\n\nTem certeza?')) {
                if (confirm('√öltima chance! Confirma a exclus√£o de TUDO?')) {
                    fetch('/api/songs/delete_all', { method: 'DELETE' })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message || 'Tudo deletado!');
                            loadAllSongs();
                        })
                        .catch(err => alert('Erro: ' + err.message));
                }
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // --- API CALLS ---

        function loadConfig() {
            // A leitura da config √© feita via /get_data no loop principal
            // Mas podemos for√ßar atualiza√ß√£o se necess√°rio
        }

        function toggleResetAuto(checkbox) {
            const valor = checkbox.checked ? 1 : 0;
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chave: 'reset_automatico', valor })
            });
        }

        function adicionarMusicaSmart() {
            const link = document.getElementById('smart-link').value;
            const plays = document.getElementById('smart-plays').value;
            const meta = document.getElementById('smart-meta').value;
            const duracao = document.getElementById('smart-duracao').value;

            if (!link) return alert("Link obrigat√≥rio");

            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-text').textContent = 'Validando m√∫sica nas playlists... (pode demorar)';

            // Chamada s√≠ncrona - resposta direta
            fetch('/api/add_music_smart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    link,
                    plays_diarios: plays,
                    meta_mensal: meta,
                    duracao_manual: duracao
                })
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';

                    if (data.status === 'error') {
                        alert('Erro: ' + data.message);
                    } else if (data.status === 'completed') {
                        alert(data.message);
                        document.getElementById('smart-link').value = '';
                        updateData();
                    } else {
                        alert('Resposta: ' + JSON.stringify(data));
                    }
                })
                .catch(err => {
                    document.getElementById('loading').style.display = 'none';
                    alert('Erro de conex√£o: ' + err.message);
                });
        }

        function loadPlaylists() {
            fetch('/api/playlists')
                .then(res => {
                    if (!res.ok) throw new Error("Erro na API: " + res.status);
                    return res.json();
                })
                .then(data => {
                    const tbody = document.querySelector('#playlists-table tbody');
                    tbody.innerHTML = '';
                    if (!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3">Nenhuma playlist encontrada.</td></tr>';
                        return;
                    }
                    data.forEach(pl => {
                        const row = `<tr>
                        <td>${pl.nome || 'Playlist'}</td>
                        <td><a href="${pl.url}" target="_blank" style="color: #1DB954">Abrir Spotify</a></td>
                        <td><button onclick="removerPlaylist(${pl.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem">X</button></td>
                    </tr>`;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                })
                .catch(err => {
                    console.error(err);
                    alert("Erro ao carregar playlists: " + err.message);
                });
        }

        function adicionarPlaylist() {
            const url = document.getElementById('playlist-url').value;
            if (!url) return;

            fetch('/api/playlists', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    document.getElementById('playlist-url').value = '';
                    loadPlaylists();
                })
                .catch(err => alert("Erro ao adicionar: " + err.message));
        }

        function removerPlaylist(id) {
            if (confirm('Remover playlist?')) {
                fetch(`/api/playlists/${id}`, { method: 'DELETE' })
                    .then(() => loadPlaylists())
                    .catch(err => alert("Erro ao remover: " + err.message));
            }
        }

        let allStatsData = []; // Guarda todos os dados para filtro
        let playsChart = null; // Refer√™ncia ao gr√°fico

        function loadStats() {
            fetch('/get_stats')
                .then(res => {
                    if (!res.ok) throw new Error("Erro na API Stats: " + res.status);
                    return res.json();
                })
                .then(data => {
                    allStatsData = data; // Salva para filtro
                    renderStats(data);
                })
                .catch(err => {
                    console.error(err);
                    alert("Erro ao carregar metas: " + err.message);
                });
        }

        function renderStats(data) {
            const filter = document.getElementById('status-filter')?.value || 'todos';
            const tbody = document.querySelector('#stats-table tbody');
            tbody.innerHTML = '';

            // Aplica filtro
            let filtered = data;
            if (filter === 'progresso') {
                filtered = data.filter(s => s.status_meta.includes('Progresso'));
            } else if (filter === 'atingida') {
                filtered = data.filter(s => s.status_meta.includes('Atingida'));
            }

            if (!filtered || filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Sem dados para este filtro.</td></tr>';
                return;
            }

            filtered.forEach(stat => {
                let color = '#fff';
                if (stat.status_meta.includes('Atingida')) color = '#1DB954';

                const row = `<tr>
                    <td>${stat.nome}</td>
                    <td>${stat.plays_hoje}</td>
                    <td>${stat.plays_mes}</td>
                    <td>${stat.meta_mensal} (${stat.percentual}%)</td>
                    <td><span style="color: ${color}; font-weight: bold">${stat.status_meta}</span></td>
                    <td><button onclick="showChart('${stat.track_id}', '${stat.nome.replace(/'/g, "\\'").substring(0, 30)}')" class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;">üìä</button></td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function showChart(trackId, trackName) {
            document.getElementById('chart-container').style.display = 'block';
            document.getElementById('chart-title').textContent = `Hist√≥rico: ${trackName}`;

            fetch(`/api/plays_history/${trackId}`)
                .then(res => res.json())
                .then(history => {
                    const labels = history.map(h => h.data);
                    const plays = history.map(h => h.plays);

                    // Destroi gr√°fico anterior se existir
                    if (playsChart) {
                        playsChart.destroy();
                    }

                    const ctx = document.getElementById('playsChart').getContext('2d');
                    playsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Plays por Dia',
                                data: plays,
                                borderColor: '#1DB954',
                                backgroundColor: 'rgba(29, 185, 84, 0.1)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                            }
                        }
                    });

                    // Scroll para o gr√°fico
                    document.getElementById('chart-container').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(err => {
                    console.error(err);
                    alert('Erro ao carregar hist√≥rico: ' + err.message);
                });
        }

        function hideChart() {
            document.getElementById('chart-container').style.display = 'none';
        }

        function updateData() {
            fetch('/get_data')
                .then(response => response.json())
                .then(data => {
                    // Atualizar stats header
                    document.getElementById('tempo-restante').textContent = formatTime(data.tempo_restante_seg);
                    document.getElementById('tempo-planejado').textContent = formatTime(data.tempo_planejado_seg);
                    document.getElementById('devices-count').textContent = data.devices_online || 0;

                    // Config (se dispon√≠vel)
                    if (data.config && document.getElementById('reset-auto-toggle')) {
                        // Check if reset_automatico is 1 or string "1"
                        const isAuto = data.config.reset_automatico == 1;
                        document.getElementById('reset-auto-toggle').checked = isAuto;
                    }

                    // Atualizar tabela da aba Adicionar (Fila de Hoje)
                    const tbody = document.getElementById('playlist-body');
                    tbody.innerHTML = '';

                    if (data.playlist) {
                        data.playlist.forEach(item => {
                            if (item.status === 'Conclu√≠do') return; // Oculta conclu√≠dos de hoje para limpar a vista

                            const progress = item.plays_desejados > 0
                                ? Math.min(100, (item.plays_atuais / item.plays_desejados) * 100) : 0;

                            let statusClass = '';
                            if (item.status === 'Pendente') statusClass = 'status-pendente';
                            if (item.status === 'Em Execu√ß√£o') statusClass = 'status-execucao';

                            const row = `<tr>
                            <td>
                                <strong>${item.nome_musica}</strong><br>
                                <small style="color: #666">...${item.link_musica.slice(-20)}</small>
                            </td>
                            <td>
                                <div>${item.plays_atuais} / ${item.plays_desejados}</div>
                                <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
                            </td>
                            <td><span class="status ${statusClass}">${item.status}</span></td>
                            <td><a href="/delete/${item.id}" class="btn btn-danger" style="padding: 5px 10px">üóëÔ∏è</a></td>
                        </tr>`;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                    }
                });
        }

        // Init
        updateData();
        setInterval(updateData, 5000);
    </script>
</body>

</html>